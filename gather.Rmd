---
title: "ADA Analysis"
author: "Monica Chang"
date: "9/25/2020"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(gt)
library(readxl)
library(lubridate)
library(skimr)
library(janitor)
```


```{r claudia data, include = FALSE}

claudia_data <- 
  read_excel("old_data/2018_transfers_and_approved_ADAs.xlsx") %>%
  clean_names()

clean_claudia_data <- claudia_data %>%
  select(-c(s_t_0_23:other_2)) %>%
  rename(pei = personalid,
         date_received = received,
         first_floor_elevator = x1st_floor_elevator,
         ac = req_a_o_ac,
         mattress = req_a_o_mattress,
         other_description = if_other_ada_accomodation_requested_please_describe_3226,
         date_decision = decision,
         date_exit = exit,
         reason_for_exit = reason,
         transfer_date = it_referral_dt,
         char_present = required_characteristics_present_in_new_unit,
         char_not_present = required_characteristics_not_present_in_new_unit,
         char_not_clear = required_characteristics_not_clear_in_new_unit)

```

```{r clean/merge 2018 and 2020 data}

ada_request_2018 <- read_excel("raw_data/2018_ADA_Requests.xlsx") %>%
  
  # Clean column names, drop unnecessary columns and correct one column name.
  
  clean_names() %>%
  select(-c("touch_point_name_111")) %>%
  rename(if_the_ada_request_occurred_in_the_ea_shelter_please_indicate_which_agency_3223 = if_the_ada_request_occurred_in_the_ea_shelter_please_indicate_w) 
  

ada_request_2020 <- read_excel("raw_data/2020_ADA_Requests.xlsx") %>%
  
  # Clean column names, drop unnecessary columns and correct column order.
  
  clean_names() %>%
  mutate(if_the_ada_request_occurred_in_the_hotel_motel_please_indicate = NA) %>%
  mutate(if_other_ada_accomodation_requested_please_describe_3226 = NA) %>%
  select(participant_enterprise_identifier, 
         date_taken_111, 
         where_did_the_ada_request_occur_3211,
         if_the_ada_request_occurred_in_the_ea_shelter_please_indicate_which_agency_3223, 
         if_the_ada_request_occurred_in_the_hotel_motel_please_indicate,
         date_that_the_central_ada_coordinator_received_ada_request_3212,
         ada_accommodation_request_3213,
         if_other_ada_accomodation_requested_please_describe_3226,
         reason_for_the_ada_request_3214,
         if_other_reason_please_describe_3227,
         date_the_decision_made_3215,
         was_the_ada_request_approved_3216,
         if_partial_please_explain_3217,
         if_closed_please_explain_3219,
         was_the_accommodations_met_3218,
         how_was_the_accommodation_met_3221,
         date_the_accommodation_met_3220) 

# Takes in a ADA request tibble that has already been filtered to the 
# correct columns. This function renames columns, eliminates 
# hyphens from the pei, parses out the accommodation type, and expresses
# each accommodation type as 1 (requested) or 0 (not requested).

clean_ada_request <- function(x) {
  x <- x %>%
    
    # Rename columns.
    
    rename(pei = participant_enterprise_identifier,
           date_taken = date_taken_111,
           req_where = where_did_the_ada_request_occur_3211,
           shelter_from = if_the_ada_request_occurred_in_the_ea_shelter_please_indicate_which_agency_3223,
           hotel_from = if_the_ada_request_occurred_in_the_hotel_motel_please_indicate,
           date_received = date_that_the_central_ada_coordinator_received_ada_request_3212,
           acc_type = ada_accommodation_request_3213,
           other_acc_type = if_other_ada_accomodation_requested_please_describe_3226,
           req_reason = reason_for_the_ada_request_3214,
           other_req_reason = if_other_reason_please_describe_3227,
           date_decision = date_the_decision_made_3215,
           approved = was_the_ada_request_approved_3216,
           partial = if_partial_please_explain_3217,
           closed = if_closed_please_explain_3219,
           acc_met = was_the_accommodations_met_3218,
           how_acc_met = how_was_the_accommodation_met_3221,
           date_acc_met = date_the_accommodation_met_3220) %>%
    
    # Eliminate hyphens from the PEI identification number.
    
    mutate(pei = gsub("-", "", pei)) %>%
    
    # Eliminate duplicate rows.
    
    distinct() %>%
    
    # No more than 4 accommodations are provided to any one row. So, I divide the
    # request column into four columns, based on the "\\|" divider. Missing 
    # values are filled on the right.
    
    separate(acc_type, into = c("a", "b", "c", "d", "e"), sep = "\\|", fill = 'right') %>%
    
    # I want to collapse these four columns into "tidy" format, where each row
    # represents a unique request made. So, I pivot the data to make it longer.
    
    pivot_longer(cols = c(a, b, c, d, e), names_to = "letter_id",  values_to = "accommodation_request") %>%
    
    # If any of the columns c(a, b, c, d, e) were empty before I pivoted longer, 
    # an "NA" value will appear. Additionally, I notice that some cells seem to
    # just contain an empty space (likely due to data entry errors). So, I drop
    # the NAs and remove the cells that are just empty spaces.
    
    drop_na(accommodation_request) %>%
    filter(accommodation_request != "") %>%
    
    # Now, I want to make the data wider again, where 1 represents that a given
    # category of accommodations was requested. I create a dummy variable '1',
    # which is just a column of 1s.
    
    mutate(dummy = 1) %>%
  
    # Finally, I pivot wider again. The names of the columns in my wider table
    # will be the values currently in the 'accommodation_request' column. The
    # values in those columns will be either 0 if the category is not
    # relevant, or 1 if the category was requested in that case.
    
    pivot_wider(id_cols = pei:date_acc_met, names_from = accommodation_request, values_from = dummy, values_fill = 0) %>%
    
    clean_names() %>%
    
    # Rename accommodation types.
    
    rename_with(~ gsub("comfort", "assistance", .x, fixed = TRUE)) %>%
    rename_with(~ gsub("scattered_site_placement_unit_co_housing_unit", "scattered_site_placement_unit", .x, fixed = TRUE)) %>%
    rename(req_a_anim = assistance_animal_within_placement_unit) %>% 
    rename(req_a_care = assigned_caretaker_temporary_non_ea_household_member) %>%
    rename(req_a_creg = change_in_ea_regulation_re_housing_plan) %>%
    rename(req_a_cook = access_to_full_cooking_facilities) %>%
    rename(req_a_ffloor = first_floor_or_elevator_access) %>%
    rename(req_a_ncarp = non_carpeted_placement_unit) %>%
    rename(req_a_pmod = physical_modification_to_placement_unit_visual_cues_for_hearing_impaired_grab_bars_in_shower_etc) %>% 
    rename(req_a_scat = scattered_site_placement_unit) %>%  
    rename(req_a_serv = placement_unit_close_to_service_providers_when_a_participant_is_placed_out_of_area_away_from_their_current_medical_providers) %>%
    rename(req_a_wchair = wheelchair_accessible_placement_unit) %>%
    rename(req_a_oth = other) %>%
    
    # Re-order columns and drop unnecessary columns.
    
    select(pei:date_acc_met, req_a_anim, req_a_care, req_a_creg, req_a_cook, req_a_ffloor, req_a_ncarp, req_a_pmod, req_a_scat, req_a_serv, req_a_wchair, req_a_oth) %>%
    
    # I parsed/renamed the reasons for request in the same way I parsed the accommodation type.
    
    separate(req_reason, into = c("f", "g", "h", "i", "j"), sep = "\\|", fill = 'right') %>%
    pivot_longer(cols = c(f, g, h, i, j), names_to = "letter_id",  values_to = "reason_for_request") %>%
    drop_na(reason_for_request) %>%
    filter(reason_for_request != "") %>%
    mutate(dummy = 1) %>%
    pivot_wider(id_cols = pei:req_a_oth, names_from = reason_for_request, values_from = dummy, values_fill = 0) %>%
    clean_names() %>%
    rename_with(~ gsub("developmental_disability_behavioral", "developmental_disability", .x, fixed = TRUE)) %>%
    rename_with(~ gsub("mental_emotional_health", "mental_health", .x, fixed = TRUE)) %>%
    rename(reason_mental = mental_health) %>% 
    rename(reason_emotional = emotional_health) %>%
    rename(reason_physical = physical_health) %>%
    rename(reason_devel_behav = developmental_disability) %>%
    rename(reason_other = other) %>%
    
    # Re-order columns and drop unnecessary columns.
    
    select(pei:req_a_oth, reason_mental, reason_mental, reason_emotional, reason_physical, reason_devel_behav, reason_other)

  }

ada_request_2018 <- clean_ada_request(ada_request_2018)
ada_request_2020 <- clean_ada_request(ada_request_2020)

# Combine the 2018 and 2020 touchpoint data.

ada_request_2018_2020 <- bind_rows(ada_request_2018, ada_request_2020)

saveRDS(ada_request_2018_2020, file = "shiny/data/ada_request_2018_2020.rds")

# TODO: Add in the other acc type + req reasons.
# TODO: Clean & merge the transfer data + HUD exit data.

```


```{r 2015-2019 ADA request tables/plots}

request_types <- ada_request_2018_2020 %>%
  pivot_longer(cols = req_a_anim:req_a_oth, names_to = "accomodation_type", values_to = "requests") %>%
  group_by(accomodation_type) %>%
  summarize(total_requests = sum(requests), .groups = "drop") %>%
  arrange(desc(total_requests)) %>%
  mutate(pct_requests = total_requests/sum(total_requests))

# Create a table showing the requests by accommodation type.

request_types %>%
  gt() %>%
  tab_header(
    title = "Percentage of ADA requests by accomodation type",
    subtitle = glue::glue("2015 to 2019")
  ) %>%
  fmt_passthrough(
    columns = vars(accomodation_type, total_requests)
  ) %>%
  fmt_percent(
    columns = vars(pct_requests)
  )
  
# Create a plot showing the requests by accommodation type.
  
request_types %>%
  ggplot(aes(x = pct_requests, y = fct_reorder(accomodation_type, pct_requests))) +
    geom_col() +
    theme_linedraw() +
    scale_y_discrete(labels = c("Caretaker", "Wheelchair", "Cooking facilities", "Physical modification", "Change in regulation", "Non-carpeted", "First floor/elevator", "Assistance animal", "Other", "Scattered site", "Service providers")) +
    labs(title = "Percentage of ADA requests by accomodation type (2015-2019)",
         x = "Percentage of requests", 
         y = "Accomodation type",
         caption = "Source: Department of Housing & Community Development")

reason_types <- ada_request_2018_2020 %>%
  pivot_longer(cols = reason_mental:reason_other, names_to = "reason_type", values_to = "requests") %>%
  group_by(reason_type) %>%
  summarize(total_requests = sum(requests), .groups = "drop") %>%
  arrange(desc(total_requests)) %>%
  mutate(pct_requests = total_requests/sum(total_requests))

# Create a table showing the requests by reason type.

reason_types %>%
  gt() %>%
  tab_header(
    title = "Percentage of ADA requests by reason type",
    subtitle = glue::glue("2015 to 2019")
  ) %>%
  fmt_passthrough(
    columns = vars(reason_type, total_requests)
  ) %>%
  fmt_percent(
    columns = vars(pct_requests)
  )

# Create a plot showing the requests by reason type.

reason_types %>%
  ggplot(aes(x = pct_requests, y = fct_reorder(reason_type, pct_requests))) +
    geom_col() +
    theme_linedraw() +
    scale_y_discrete(labels = c("Other", "Developmental/ \nbehavioral disability", "Emotional health", "Mental health", "Physical health")) +
    labs(title = "Percentage of ADA requests by reason type (2015-2019)",
         x = "Percentage of requests", 
         y = "Reason type",
         caption = "Source: Department of Housing & Community Development")
```


